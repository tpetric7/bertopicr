---
title: "Train and Save a BERTopic Model"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Train and Save a BERTopic Model}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = FALSE)
```

This vignette shows how to train a BERTopic model from R and persist it to disk
along with the R-side extras (probabilities, reduced embeddings, and dynamic
topic outputs). Set `eval = TRUE` for the chunks you want to run.

## Environment setup

```{r}
library(reticulate)
library(bertopicr)
library(readr)
library(dplyr)

# macOS: if reticulate fails to load Python libraries, run once per session.
if (identical(Sys.info()[["sysname"]], "Darwin")) {
  bertopicr::configure_macos_homebrew_zlib()
}

# Point reticulate at your Python environment that has BERTopic installed.
use_virtualenv("c:/path/to/your/venv", required = TRUE)

reticulate::py_config()
reticulate::py_available()
reticulate::py_run_string(code = "import torch
print(torch.cuda.is_available())") # if GPU is available then TRUE else FALSE)

```

## Load sample data

Below, the German sample dataframe is used for topic analysis. 

```{r}
sample_path <- system.file("extdata", "spiegel_sample.rds", package = "bertopicr")
df <- read_rds(sample_path)
docs <- df |> pull(text_clean)
```

## Train the model

The `train_bertopic_model()` function is a convenience function. For more options / parameter finetuning, see the other vignette (topics_spiegel.Rmd) or the Quarto file (inst/extdata/topics_spiegel.qmd). 

For more settings of the `train_bertopic_model()` function, check the help file.

```{r}
topic_model <- train_bertopic_model(
  docs = docs,
  top_n_words = 50L, # set integer numbger of top words
  embedding_model = "Qwen/Qwen3-Embedding-0.6B", # choose your (multilingual) model from huggingface.co
  embedding_show_progress = TRUE,
  timestamps = df$date, # set this to NULL if not applicable with your data
  classes = df$genre, # set this to NULL if not applicable with your data
  representation_model = "keybert" # keyword generation for each topic
)
```

## Save the model and extras

> BERTopic - WARNING: When you use `pickle` to save/load a BERTopic model,please make sure that the environments in which you save and load the model are **exactly** the same. The version of BERTopic,its dependencies, and python need to remain the same.

```{r}
save_bertopic_model(topic_model, "topic_model")
```
